

<!DOCTYPE html>
  <head>
    <title>newsource</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@1.7.6/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@1.7.6/dist/js/tom-select.complete.min.js"></script>
    <link href="{{ url_for('static',  filename='js/tom-select.bootstrap5.css') }}" rel="stylesheet">

</head>

  <body>
      <div class="container my-4"> 
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary my-5" id="loading-form" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <form id="new-source" autocomplete="off" autocorrect="off" spellcheck="false" style="display: none;">
            <div class="progress my-4">
                <div id="questionnaire-progress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <fieldset id="section-general">
                <div class="mb-3 form-group">
                    <label for="channel-select" class="form-label">Through which channel is the news source distributed?</label>
                    <!-- <input class="form-control" list="channel-options" id="channel-select" placeholder="Type to search..."> -->
                    <select name="channel" id="channel-select" class="form-select" aria-describedby="channel-select-feedback" required>
                        <option value="" selected>Select...</option>
                    </select>
                    <div id="channel-select-feedback"></div>
                    <input type="text" name="channel_uid" id="channel-select-hidden" style="display: none;">
                </div>
                <div id="group-channel-new" class="mb-3" style="display: none;">
                    <label for="channel-new" class="form-label">Please specify the channel that is not listed above:</label>
                    <input type="text" name="channel_new" class="form-control" id="channel-new" aria-describedby="channel-new-feedback">
                    <div id="channel-new-feedback"></div>
                </div>
                <div class="mb-3">
                    <div id="group-name" class="form-group">
                        <label for="name" class="form-label">What is the name of the print news source?</label>
                    <div class="input-group">
                        <span class="input-group-text" id="name-addon">https://www.facebook.com/</span>
                        <input name="name" type="text" class="form-control" id="source-name" placeholder="e.g. 'The Royal Gazette'" aria-describedby="name-feedback" required>
                        <div id="name-feedback"></div>
                        </div>
                        <small id="name-helptext"></small>
                    </div>
                    <div id="group-transcript-kind" class="my-3 form-group">
                        <label for="transcript-kind" class="form-label">What kind of show is transcribed?</label>
                        <select name="transcript_kind" class="form-select" id="transcript-kind" aria-describedby="transcript-kind-feedback">
                            <option value="" selected>Choose...</option>
                            <option value="tv">TV (broadcast, cable, satellite, etc)</option>
                            <option value="radio">Radio</option>
                            <option value="podcast">Podcast</option>    
                            <option value="None">Don't know</option>
                        </select>
                        <div id="transcript-kind-feedback"></div>
                    </div>
            </div>
            
            <div class="mb-3 form-group">
                <label for="other-names" class="form-label">Is the news source known by alternative names (e.g. Krone, Die Kronen Zeitung)? Please type them here:</label>
                <select type="text" name="other_names" class="form-control" id="other-names" placeholder="Separate by comma" multiple></select>
            </div>

            <div id="group-epaper" class="mb-3 form-group" style="display: none;">
                <label for="channel-epaper" class="form-label">Does the print news source have an e-paper version? Please insert the url here:</label>
                <input name="channel_epaper" type="text" class="form-control" id="channel-epaper" placeholder="Please specify (e.g., https://swmh-epaper.s4p-iapps.com/)">
            </div>

            <div id="group-channel-comments" class="mb-3 form-group" style="display: none;">
                <label for="channel-comments" class="form-label">Does the online news source have user comments below individual news articles?</label>
                <select name="channel_comments" type="text" class="form-control" id="channel-comments" placeholder="Please specify (e.g., https://swmh-epaper.s4p-iapps.com/)" aria-describedby="channel-comments-feedback">
                    <option value="">Choose...</option>
                    <option label="No comments">No comments</option>
                    <option label="User comments with registration">Registration required</option>
                    <option label="User comments without registration">Anyone</option>
                    <option label="Don't know">DK</option>
                </select>
                <div id="channel-comments-feedback"></div>
                </div>
            
            <div class="mb-3 form-group">
                <label for="source-founded" class="form-label">What year was the news source founded?</label>
                <input name="founded" type="number" step="1" min="1900" max="2100" class="form-control" id="source-founded" placeholder="Format: YYYY" aria-describedby="founded-feedback">
                <div id="founded-feedback"></div>
                </div>

                <input type="button" class="btn btn-primary next" value="Next Step">
            </fieldset>


         <!-- SECTION: ECONOMIC VARIABLES -->
            <fieldset id="section-economic" style="display: none;">
                <div id="group-payment-model" class="mb-3 form-group">
                    <label for="payment-model" class="form-label">Is the content produced by the news source accessible free of charge?</label>
                    <select name="payment_model" class="form-select" id="payment-model" aria-describedby="payment-model-feedback" required>
                        <option value="" selected>Choose...</option>
                        <option value="free">Free</option>
                        <option value="soft paywall">Soft paywall</option>
                        <option value="subscription">Subscription</option>    
                        <option value="None">Don't know</option>
                    </select>
                    <div id="payment-model-feedback"></div>
                </div>

                <div id="group-contains-ads" class="mb-3 form-group">
                    <label for="contains-ads" class="form-label">Does the news source contain advertisements?</label>
                    <select name="contains_ads" class="form-select" id="contains-ads" aria-describedby="contains-ads-feedback" required>
                        <option value="" selected>Choose...</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                        <option value="non subscribers">Only for non-paying users</option>    
                        <option value="None">Don't know</option>
                    </select>
                    <div id="contains-ads-feedback"></div>
                </div>

                <div id="group-publishes" class="mb-3 form-group">
                    <label for="publishes" class="form-label">Which organization or person owns the news source?</label>
                    <select name="publishes" id="publishes" class="form-select form-select-lg" placeholder="Separate by comma" multiple></select>
                    <small id="publishes-helptext">e.g. The print newspaper The Guardian is owned by Guardian Media Group. To identify this information please check the imprint (or imprint alike information)</small>
                </div>

                <div id="group-ownership-kind" class="mb-3 form-group">
                    <label for="ownership-kind" class="form-label">Is the news source funded mainly public or mainly private?</label>
                    <select name="ownership_kind" class="form-select" id="ownership-kind" aria-describedby="ownership-kind-feedback" required>
                        <option value="" selected>Choose...</option>
                        <option value="public ownership">Mainly public</option>
                        <option value="private ownership">Mainly Private</option>
                        <option value="unknown">News source does not mention the type of funding</option>    
                        <option value="None">Don't know</option>
                    </select>
                    <div id="ownership-kind-feedback"></div>
                    <small id="ownership-kind-helptext">To identify this information please check the imprint (or imprint alike information)</small>
                </div>



                <input type="button" class="btn btn-primary prev" value="Previous Step">
                <input type="button" class="btn btn-primary next" value="Next Step">
            </fieldset>
            <fieldset id="section-final" style="display: none;">
                <input type="button" class="btn btn-primary prev" value="Previous Step">
                <input type="submit" class="btn btn-success" value="Submit" />
            </fieldset>
            <div class="mb-3 d-flex flex-row-reverse">
                <input type="reset" class="btn btn-danger" id="reset-form" value="Reset form" />
            </div>
        
        </form>
</div>

<script>

    // rewrite everything with jquery https://tobiasahlin.com/blog/move-from-jquery-to-vanilla-javascript/#selecting-elements
    // GLOBAL CONSTANTS
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    const csrftoken = "{{ csrf_token() }}";
    
    // ********************
    // Function declaration
    // ********************

    // Get custom attribute (data-value) from all select and put them in hidden fields
    (function($) {
        $.fn.extend({
            inputSelectToHidden: function() {
                return this.change(function() {
                    var option = $('option:selected', this).attr('data-value');
                    var hidden = $("#" + this.id + "-hidden");
                    hidden.val(option);
                })
                }
        });
    })(jQuery);

    function addFieldOptions(fieldOptions, key, selector) {
        fieldOptions[key].forEach(function(item, i) {
            $(selector).append('<option value="' + item.unique_name + '" data-value="' + item.uid + '" data-index="' + i + '">' + item.name + '</option>');

    })
        $(selector).append('<option value="other" data-value="new" data-index="99">Other</option>');

    };

    function getFieldOptions(targetUrl) {
        return new Promise(function(resolve, reject) {
            $.ajax({
                url: targetUrl,
                success: function(data) {
                    resolve(data); // Resolve promise and go to then()
                    $('#loading-form').hide();
                    $('#new-source').show();
                },
                error: function(err) {
                    reject(err) // Reject the promise and go to catch()
                }
            });
        });
    }

    // Field Visibility Logic
    function fieldVisibility(fieldOptions, allNames, el) {
        var value = $(el).find(':selected').val();
        var index = $(el).find(':selected').data('index');
        if (index == null) {
            return;
        }
        allNames.hide()
        $('#group-channel-new').hide();
        $('#group-name').show();
        if (index != 99) {
            $('#group-name label').html(fieldOptions.channel[index]['form_name_question']);
            $('#source-name').attr("placeholder", fieldOptions.channel[index]['form_name_placeholder']);
            if ('form_name_helptext' in fieldOptions.channel[index]) {
                $('#name-helptext').html(fieldOptions.channel[index]['form_name_helptext']);
            } else { $('#name-helptext').html("") };
            if ('form_name_addon' in fieldOptions.channel[index]) {
                $('#name-addon').show().html(fieldOptions.channel[index]['form_name_addon']);
            } else { $('#name-addon').hide() };
        } else {
            $('#group-name label').html("What is the name of the news source that you suggest?");
            $('#source-name').attr("placeholder", "");
            $('#name-addon').hide();
        };

        // Set / Reset certain fields to be required
        $('#transcript-kind').attr("required", false);
        $('#channel-new').attr("required", false);
        $('#channel-comments').attr("required", false);

        if (value == 'other') {
            $('#group-channel-new').show();
            $('#channel-new').attr("required", true);
        } else if (value == 'print') {
            $('#group-epaper').show()
        } else if (value == 'transcript') {
            $('#group-transcript-kind').show();
            $('#transcript-kind').attr("required", true);
        } else if (value == 'website') {
            $('#group-channel-comments').show();
            $('#channel-comments').attr("required", true);
        }
    };

    // make form persistent with local storage
    function getFormData(f, fID) {
        let data = {
            [fID]: {}
        };
        for (var element of f.elements) {
            if (element.name.length > 0) {
                data[fID][element.name] = element.value;
            }
        }
        return data;
    };

    // populate form on page load
    function populateForm(f, fID) {
        if (localStorage.key(fID)) {
            var savedData = JSON.parse(localStorage.getItem(fID));
            for (var element of f.elements) {
                if (element.name in savedData) {
                    element.value = savedData[element.name];
                }
            }
        }
    };

    // Progress Bar
    function setProgressBar(curStep, steps) {
        var percent = parseFloat(100 / steps) * curStep;
        percent = percent.toFixed();
        $("#questionnaire-progress").css("width", percent + "%")
        $("#questionnaire-progress").attr('aria-valuenow', percent + "%")
    };


    $(document).ready(function() {

        // declare constants
        const formId = "new-source";
        const formUrl = location.href;
        const formIdentifier = `${formUrl} ${formId}`;
        var persistentForm = document.querySelector(`#${formId}`)

        // Load Select options from json api
        getFieldOptions('{{ url_for("records.fieldoptions") }}').then(function(data) {
                addFieldOptions(data, 'channel', '#channel-select');

                // handle field visibility / dependency logic
                const allNames = $('#group-name, #group-epaper, #group-channel-comments, #group-transcript-kind')
                allNames.hide()
                $('#channel-select').change(function() {
                    let element = $(this);
                    fieldVisibility(data, allNames, element);
                    });

                // Populate form with locally stored data
                populateForm(persistentForm, formIdentifier);
                $('#channel-select').change();


            }).catch(function(err) {
                // Run this when promise was rejected via reject()
                console.log(err)
            })       

        // Get custom attribute (data-value) from all select and put them in hidden fields
        $('select').inputSelectToHidden();

        // persistence: save changes in form
        $("#" + formId).change(function() {
            var data = getFormData(persistentForm, formIdentifier);
            localStorage.setItem(formIdentifier, JSON.stringify(data[formIdentifier]));
        });

        // persistence: clear local storage on "reset"
        $("#reset-form").click(function() {
            localStorage.removeItem(formIdentifier);
        })

        // form progression in multiple steps
        var current = 0,
            current_step, next_step, steps;
        steps = $("fieldset").length;
        $('.next').click(function() {
            current_step = $(this).parent();
            for (field of current_step[0].elements) { 
                if (!visited.includes(field)) {
                        visited.push(field);
                    }
                var validatedField = field.reportValidity() 
                if (!validatedField) {                    
                    return;
                };
            };

            next_step = $(this).parent().next();
            next_step.fadeIn('fast');
            current_step.hide();
            setProgressBar(++current, steps);
        });

        $('.prev').click(function() {
            current_step = $(this).parent();
            prev_step = $(this).parent().prev();
            prev_step.fadeIn('fast');
            current_step.hide();
            setProgressBar(--current, steps);
        });
        setProgressBar(current, steps);

    });

    // validation & submission

    const form = document.getElementById("new-source");
    form.noValidate = true;
    form.addEventListener('submit', function handleFormSubmit(event) {
        const isValid = form.reportValidity();

        if (isValid) {
            // POST form data to backend with fetch
            submitForm('{{ url_for("records.echo_json") }}', form);
        };

        event.preventDefault();
        });

    const visited = [];
    for (const field of form.elements) {
        field.addEventListener("invalid", function handleInvalidField(event) {
            setFieldValidity(field);
            event.preventDefault();
            });

        field.addEventListener("blur", function handleFieldBlur() {
            
            if (!visited.includes(field)) {
                visited.push(field);
                }
            field.checkValidity();
            });

        field.addEventListener("input", function handleFieldInput(event) {
            if (!visited.includes(field)) return;
            setFieldValidity(field); 
            
        });

        }

    function errorContainer(field) {
        const errorContainerId = field
            .getAttribute("aria-describedby")
            .split(" ")
            .find((id) => id.includes("feedback"));
        return document.getElementById(errorContainerId);
    }

    function setFieldValidity(field) {
        if (!field.validity.valid) {
            errorContainer(field).textContent = field.validationMessage;
            errorContainer(field).classList.add('invalid-feedback');
            field.setAttribute("aria-invalid", "true");
            field.classList.add('is-invalid');
        } else {
            errorContainer(field).textContent = "";
            errorContainer(field).classList.remove('invalid-feedback');
            field.removeAttribute("aria-invalid");
            field.classList.remove('is-invalid');
        }
    }


    // submit form
    
    $.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken)
        }
        }
    });


    function submitForm(endpoint, form) {
        var serializeForm = function (form) {
            var obj = {};
            var formData = new FormData(form);
            
            var obj = Object.fromEntries(
                Array.from(formData.keys()).map(key => [
                    key, formData.getAll(key).length > 1 ? 
                    formData.getAll(key) : formData.get(key)
                ])
                )

            return obj;
        };
        $.ajax({
            type: "POST",
            url: endpoint,
            data: JSON.stringify(serializeForm(form)),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data)
            }
        })

    };

    // autocomplete organization

    var TomSelectOrganizationConfig = {
        plugins: ['remove_button'],
        create: function(input,callback){
                var returnData = {
                    value:input,
                    text:input,
                    name:input,
                    country: [
                        {name: 'none'}
                    ]
            };
                console.log(returnData)
                callback(createItem(returnData));
            },
        valueField: 'uid',
        labelField: 'name',
        searchField: 'name',
        delimiter: ',',
        selectOnTab: true,
        // createFilter: function(input) { return input.length >= 3 },
        load: function(query, callback) {
            if ( query.length < 3 ) return callback();
            var url = '{{ url_for("records.orglookup") }}?person=false&q=' + encodeURIComponent(query);
            fetch(url)
            .then(response => response.json())
            .then(json => {
                callback(json.data);
            }).catch(() => {callback();});
        },
        render: {
            option: function(data, escape) {
                return '<div>' +
                        '<span class="title">' + escape(data.name) + '</span>' +
                        '<small class="text-muted mx-1"> (' + escape(data.country[0].name) + ')</small>' +
                    '</div>';
            },
            item: function(data, escape) {
                console.log(data);
                return '<div>' + escape(data.name) + ' <small class="mx-1"> (' + escape(data.country[0].name) + ')</small></div>';
            }
	    }
    };
    new TomSelect('#publishes', TomSelectOrganizationConfig);

    var TomSelectOtherNamesConfig = {
        plugins: ['remove_button'],
        create: true,
        render: {
            no_results:function(data,escape){
			    return '<div></div>';
		}
        }
    };

    new TomSelect('#other-names', TomSelectOtherNamesConfig);


</script>


  </body>
</html>