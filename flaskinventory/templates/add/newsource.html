{% extends "layout.html" %} {% block content %}
<div class="row align-items-center justify-content-center" id="loading-form">
    <div class="card text-center w-25" id="loading-card">
        <div class="card-top">
            <i class="fa fa-check text-success fs-1 my-5" id='submit-success-icon' hidden> </i>
            <div class="spinner-border text-primary my-5" role="status" id="loading-spinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div class="card-body">
            <h5 class="card-title" id="loading-status">Loading...</h5>
            <p class="card-text" id="loading-status-message">We are getting the form ready</p>
            <div class="btn-group" role="group" aria-label="loading controls"></div>
                <a href="#" class="btn btn-light" id="btn-fail-goback" hidden>Go back and edit</a>
                <a href="#" class="btn btn-outline-info" id="btn-viewentry" hidden>View new entry</a>
                <a href="{{ url_for('add.from_draft') }}" class="btn btn-success" id="btn-add-another" data-bs-toggle="tooltip" data-bs-placement="bottom" title="If you added related sources, we will take you there." hidden>Add another</a>
            </div>
        </div>
    </div>
</div>
<form id="new-source" autocomplete="off" autocorrect="off" spellcheck="false" hidden>
    <div class="progress my-4">
        <div id="questionnaire-progress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <fieldset id="section-general">
        <h3 class="mb-4">General Information</h3>
        <div class="mb-5 form-group">
            <input type="text" name="uid" id="uid-hidden" value='_:newsource' readonly hidden>
            <label for="channel-select" class="form-label fw-bold fs-5">Through which channel is the news source distributed?</label>
            <select name="channel" id="channel-select" class="form-select form-select-lg" aria-describedby="channel-select-feedback" required>
                        <option value="">Select Channel...</option>
                    </select>
            <div id="channel-select-feedback"></div>
            <input type="text" name="channel_uid" id="channel-select-hidden" hidden>
        </div>
        <div id="group-channel-new" class="mb-5" hidden>
            <label for="channel-new" class="form-label fw-bold fs-5">Please specify the channel that is not listed above:</label>
            <input type="text" name="channel_new" class="form-control form-control-lg" id="channel-new" aria-describedby="channel-new-feedback">
            <div id="channel-new-feedback"></div>
        </div>
        <div class="mb-5">
            <div id="group-name" class="form-group mb-4">
                <label for="name" class="form-label fw-bold fs-5">What is the name of the print news source?</label>
                <small id="name-helptext"></small>
                <div class="input-group input-group-lg">
                    <span class="input-group-text" id="name-addon">https://www.facebook.com/</span>
                    <input name="name" type="text" class="form-control" id="name" placeholder="e.g. 'The Royal Gazette'" aria-describedby="name-feedback" autocomplete="off" required>
                </div>
                <div id="name-feedback"></div>
        </div>
            <div id="group-transcript-kind" class="form-group">
                <div class="form-group mb-4">
                    <label for="channel_url" class="form-label fw-bold fs-5">What is the name of the website that provides tv, radio, or podcast scripts?</label>
                    <p><small id="channel_url-helptext">Please specify the archive name or the direct URL (e.g., https://www.deutschlandfunk.de/die-nachrichten-nachlesen.1794.de.html; https://www.ndr.de/nachrichten/info/index.html)</small></p>
                    <input name="channel_url" type="text" class="form-control form-control-lg" id="channel_url" placeholder="e.g. 'The Royal Gazette'" aria-describedby="channel_url-feedback" autocomplete="off">
                </div>
                <div id="channel_url-feedback"></div>

                <div id="group-transcript-kind-radiobuttons" class="mb-4 fs-5">
                <p class="form-label fw-bold fs-5">What kind of show is transcribed?</p>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="transcript_kind" id="transcript_kind1" value="tv" aria-describedby="transcript-kind-feedback">
                    <label class="form-check-label" for="transcript_kind1">
                                TV (broadcast, cable, satellite, etc)
                            </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="transcript_kind" id="transcript_kind2" value="radio" aria-describedby="transcript-kind-feedback">
                    <label class="form-check-label" for="transcript_kind2">
                                Radio
                            </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="transcript_kind" id="transcript_kind3" value="podcast" aria-describedby="transcript-kind-feedback">
                    <label class="form-check-label" for="transcript_kind3">
                                Podcast
                            </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="transcript_kind" id="transcript_kind4" value="none" aria-describedby="transcript-kind-feedback">
                    <label class="form-check-label" for="transcript_kind4">
                                Don't know
                            </label>
                    <div id="transcript-kind-feedback"></div>
                </div>
                </div>
            </div>
        </div>

        <!-- Optional Field -->
        <div id="group-other-names" class="mb-5 form-group">
            <label for="other-names" class="form-label fw-bold fs-5">Is the news source known by alternative names (e.g. Krone, Die Kronen Zeitung)? Please type them here:<span class="text-muted mx-3">(optional)</span></label>
            <input type="text" name="other_names" class="form-control form-control-lg" id="other-names" placeholder="Separate by comma" multiple>
            <div id="other-names-feedback"></div>
        </div>

        <div id="group-channel-comments" class="mb-5 form-group fs-5" hidden>
            <p class="form-label fw-bold fs-5">Does the online news source have user comments below individual news articles?</p>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="channel_comments" id="channel_comments1" value="no comments" aria-describedby="channel-comments-feedback">
                <label class="form-check-label" for="channel_comments1">
                        No comments
                    </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="channel_comments" id="channel_comments2" value="user comments with registration" aria-describedby="channel-comments-feedback">
                <label class="form-check-label" for="channel_comments2">
                        Registration required
                    </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="channel_comments" id="channel_comments3" value="user comments without registration" aria-describedby="channel-comments-feedback">
                <label class="form-check-label" for="channel_comments3">
                        Anyone
                    </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="channel_comments" id="channel_comments4" value="none" aria-describedby="channel-comments-feedback">
                <label class="form-check-label" for="channel_comments4">
                        Don't know
                    </label>
                <div id="channel-comments-feedback"></div>
            </div>
        </div>

        <div id="group-source-founded" class="mb-5 form-group">
            <label for="source-founded" class="form-label fw-bold fs-5">What year was the news source founded?<span class="text-muted mx-3">(optional)</span></label>
            <input name="founded" type="number" step="1" min="1700" max="2100" class="form-control form-control-lg" id="source-founded" placeholder="Format: YYYY" aria-describedby="founded-feedback">
            <div id="founded-feedback"></div>
        </div>

        <input type="button" class="btn btn-primary next" value="Next Step">
    </fieldset>


    <!-- SECTION: ECONOMIC VARIABLES -->
    <fieldset id="section-economic" hidden>
        <h3 class="mb-4">Economic Information</h3>
        <div id="group-payment-model" class="mb-5 form-group fs-5">
            <p class="form-label fw-bold fs-5">Is the content produced by the news source accessible free of charge?</p>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_model" id="payment_model1" value="free" aria-describedby="payment-model-feedback" required>
                <label class="form-check-label" for="payment_model1">
                               Free
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_model" id="payment_model2" value="soft paywall" aria-describedby="payment-model-feedback" required>
                <label class="form-check-label" for="payment_model2">
                                Soft paywall
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_model" id="payment_model3" value="subscription" aria-describedby="payment-model-feedback" required>
                <label class="form-check-label" for="payment_model3">
                                Subscription
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_model" id="payment_model4" value="none" aria-describedby="payment-model-feedback" required>
                <label class="form-check-label" for="payment_model4">
                                Don't know
                            </label>
            </div>
            <div id="payment-model-feedback"></div>
        </div>




        <div id="group-contains-ads" class="mb-5 form-group fs-5">

            <p for="contains_ads" class="form-label fw-bold fs-5">Does the news source contain advertisements?</p>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="contains_ads" id="contains_ads1" value="yes" aria-describedby="contains-ads-feedback" required>
                <label class="form-check-label" for="contains_ads1">
                               Yes
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="contains_ads" id="contains_ads2" value="no" aria-describedby="contains-ads-feedback" required>
                <label class="form-check-label" for="contains_ads2">
                                No
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="contains_ads" id="contains_ads3" value="non subscribers" aria-describedby="contains-ads-feedback" required>
                <label class="form-check-label" for="contains_ads3">
                                Only for non-paying users
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="contains_ads" id="contains_ads4" value="none" aria-describedby="contains-ads-feedback" required>
                <label class="form-check-label" for="contains_ads4">
                                Don't know
                            </label>
                <div id="contains-ads-feedback"></div>
            </div>
        </div>

        <!-- Optional Field -->
        <div id="group-publishes" class="mb-5 form-group">
            <p class="form-label fw-bold fs-5">Which organisation or person owns the news source?<span class="text-muted mx-3">(optional)</span></p>
            <p><small id="publishes_org-helptext" class="mb-3">e.g. The print newspaper The Guardian is owned by Guardian Media Group. To identify this information please check the imprint (or imprint alike information)</small></p>
            <div class="input-group my-3">
                <span class="input-group-text">Organisation</span>
                <select name="publishes_org" id="publishes_org" class="form-select form-select-lg" placeholder="Select multiple or add new..." multiple></select>
            </div>
            <div class="input-group">
                <span class="input-group-text">Person</span>
                <select name="publishes_person" id="publishes_person" class="form-select form-select-lg" placeholder="Select multiple or add new..." multiple></select>
            </div>
        </div>

        <div id="group-ownership-kind" class="mb-5 form-group fs-5">
            <p class="form-label fw-bold fs-5">Is the news source funded mainly public or mainly private?</p>
            <p><small id="ownership-kind-helptext">To identify this information please check the imprint (or imprint alike information)</small></p>


            <div class="form-check">
                <input class="form-check-input" type="radio" name="ownership_kind" id="ownership_kind1" value="public ownership" aria-describedby="ownership-kind-feedback" required>
                <label class="form-check-label" for="ownership_kind1">
                               Mainly public
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ownership_kind" id="ownership_kind2" value="private ownership" aria-describedby="ownership-kind-feedback" required>
                <label class="form-check-label" for="ownership_kind2">
                                Mainly private
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ownership_kind" id="ownership_kind3" value="unknown" aria-describedby="ownership-kind-feedback" required>
                <label class="form-check-label" for="ownership_kind3">
                                News source does not mention the type of funding
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ownership_kind" id="ownership_kind4" value="none" aria-describedby="ownership-kind-feedback" required>
                <label class="form-check-label" for="ownership_kind4">
                                Don't know
                            </label>
                <div id="ownership-kind-feedback"></div>
            </div>
        </div>

        <input type="button" class="btn btn-primary prev" value="Previous Step">
        <input type="button" class="btn btn-primary next" value="Next Step">
    </fieldset>

    <!-- SECTION JOURNALISTIC ROUTINE -->

    <fieldset id="section-routines" hidden>
        <h3 class="mb-4">Information about Journalistic Routines</h3>

        <div id="group-publication-kind" class="mb-5 form-group">
            <label for="publication-kind" class="form-label fw-bold fs-5">What label or labels describe the source?</label>
            <p><small id="publication-kind-helptext">To identify this information please refer to the learning module.</small></p>
            <select name="publication_kind" class="form-select form-select-lg" id="publication-kind" aria-describedby="publication-kind-feedback" placeholder="Select multiple or add new..." required multiple>
                        <option value="newspaper">Newspaper</option>
                        <option value="news agency">News Agency</option>
                        <option value="magazine">Magazine</option>
                        <option value="tv show">TV Show</option>
                        <option value="radio show">Radio Show</option>
                        <option value="podcast">Podcast</option>
                        <option value="news blog">News Blog</option>
                        <option value="alternative media">Alternative Media</option>
                        <option value="none">Don't know</option>
                    </select>
            <div id="publication-kind-feedback"></div>

        </div>



        <div id="group-special-interest" class="mb-5 form-group fs-5">
            <p class="form-label fw-bold fs-5">Does the news source have one main topical focus?</p>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="special_interest" id="special_interest1" value="no" aria-describedby="special-interest-feedback" checked>
                <label class="form-check-label" for="special_interest1">
                                No, it is a general interest news source (i.e., general news) 
                            </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="special_interest" id="special_interest2" value="yes" aria-describedby="special-interest-feedback">
                <label class="form-check-label" for="special_interest2">
                            Yes, is a special interest news source (i.e., clear focus on one topic) 
                        </label>
            </div>
            <div id="special-interest-feedback"></div>
        </div>

        <div id="group-topical-focus" class="mb-5 form-group" hidden>
            <label for="topical-focus" class="form-label fw-bold fs-5">What is the main topical focus of the news source?</label>
            <select name="topical_focus" class="form-select form-select-lg" id="topical-focus" aria-describedby="topical-focus-feedback" multiple>
                        <option value="" selected>Choose...</option>
                        <option value="politics">Politics</option>
                        <option value="society">Society & Panorama</option>
                        <option value="economy">Economy, Finance & Stocks</option>
                        <option value="religion">Religion</option>
                        <option value="science">Science & Technology</option>
                        <option value="media">Media</option>
                        <option value="environment">Environment</option>
                        <option value="education">Education</option>
                        <option value="none">Don't know</option>
                    </select>
            <div id="topical-focus-feedback"></div>
            <small id="topical-focus-helptext"></small>
        </div>

        <div id="group-publication-cycle" class="mb-3 form-group">
            <label for="publication-cycle" class="form-label fw-bold fs-5">What is the publication cycle of the source?</label>
            <select name="publication_cycle" class="form-select form-select-lg" id="publication-cycle" aria-describedby="publication-cycle-feedback" required>
                        <option value="" selected>Choose...</option>
                        <option value="continuous">Continuous (mainly applicable for online news / social media / messenger)</option>
                        <option value="daily">Daily (7 times a week)</option>
                        <option value="multiple times per week">Multiple times per week</option>
                        <option value="weekly">Once a week</option>
                        <option value="twice a month">Twice a month</option>
                        <option value="monthly">Monthly</option>
                        <option value="none">Don't know</option>
                    </select>
            <div id="publication-cycle-feedback"></div>
            <small id="publication-cycle-helptext"></small>
        </div>

        <div id="group-publication-cycle-weekday" class="mb-5 fs-5" hidden>
                <p class="form-label fs-6 fw-bold">Please indicate the specific day(s)</p>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_1" id="publication-cycle-weekday-1" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-1">Monday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_2" id="publication-cycle-weekday-2" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-2">Tuesday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_3" id="publication-cycle-weekday-3" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-3">Wednesday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_4" id="publication-cycle-weekday-4" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-4">Thursday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_5" id="publication-cycle-weekday-5" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-5">Friday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_6" id="publication-cycle-weekday-6" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-6">Saturday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_7" id="publication-cycle-weekday-7" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-7">Sunday</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" aria-describedby="publication-cycle-weekday-feedback" type="checkbox" name="publication_cycle_weekday_none" id="publication-cycle-weekday-none" value="yes">
                <label class="form-check-label" for="publication-cycle-weekday-none">Don't know</label>
            </div>
            <div id="publication-cycle-weekday-feedback"></div>
        </div>

        <input type="button" class="btn btn-primary prev" value="Previous Step">
        <input type="button" class="btn btn-primary next" value="Next Step">
    </fieldset>

    <!-- SECTION AUDIENCE RELATED -->

    <fieldset id="section-audience" hidden>
        <h3 class="mb-4">Information about the Audience</h3>

        <div id="group-geographic-scope" class="mb-5 form-group fs-5">
            <div>
                <p class="form-label fw-bold fs-5">What is the geographic scope of the news source? Who is the audience that the source is primarily addressing? </p>
                <p><small id="geographic-scope-helptext">This information can be inferred from the content (e.g., actors, topics, events).</small></p>
            </div>
            <div class="form-check">
                <input class="form-check-input" aria-describedby="geographic-scope-feedback" type="radio" name="geographic_scope" id="geographic_scope1" value="multinational">
                <label class="form-check-label" for="geographic_scope1">
                            Multinational (e.g., EU in general, German-speaking countries)
                        </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" aria-describedby="geographic-scope-feedback" type="radio" name="geographic_scope" id="geographic_scope2" value="national">
                <label class="form-check-label" for="geographic_scope2">
                            National (consumed mainly in one country) 
                        </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" aria-describedby="geographic-scope-feedback" type="radio" name="geographic_scope" id="geographic_scope3" value="subnational">
                <label class="form-check-label" for="geographic_scope3">
                            Subnational (consumed in a city/county/province/department)
                        </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" aria-describedby="geographic-scope-feedback" type="radio" name="geographic_scope" id="geographic_scope4" value="none">
                <label class="form-check-label" for="geographic_scope4">
                            Don't know
                        </label>
            </div>
            <div id="geographic-scope-feedback"></div>
        </div>

        <div id="group-geographic-scope-multiple" class="mb-5 form-group">
            <label for="geographic-scope-multiple" class="form-label fw-bold fs-5">What is the multinational scope?</label>
            <small id="geographic-scope-multiple-helptext"></small>
            <select name="geographic_scope_multiple" id="geographic-scope-multiple" class="form-select form-select-lg" aria-describedby="geographic-scope-multiple-feedback" placeholder="Select multiple or create new entries..." autocomplete="off" required multiple></select>
            <input id="geographic-scope-countries-hidden" name="geographic_scope_countries" type="text" class="form-control" readonly>
            <input id="geographic-scope-subunits-hidden" name="geographic_scope_subunits" type="text" class="form-control" readonly>
            <div id="geographic-scope-multiple-feedback"></div>
        </div>

        <div id="group-geographic-scope-subunit" class="mb-5 form-group" hidden>
            <label for="geographic-scope-subunit" class="form-label fw-bold fs-5">What is the subnational scope?</label>
            <select type="text" name="geographic_scope_subunit" class="form-control form-control-lg" id="geographic-scope-subunit" aria-describedby="geographic-scope-subunit-feedback" placeholder="Enter name(s) and separate by comma..." multiple></select>
            <div id="geographic-scope-subunit-feedback"></div>
        </div>

        <div id="group-geographic-scope-single" class="mb-5 form-group" hidden>
            <label for="geographic-scope-single" class="form-label fw-bold fs-5">What is the national scope?</label>
            <select name="geographic_scope_single" id="geographic-scope-single" class="form-select form-select-lg" aria-describedby="geographic-scope-single-feedback" placeholder="Select one..." autocomplete="off"></select>
            <small id="geographic-scope-single-helptext"></small>
            <div id="geographic-scope-single-feedback"></div>
        </div>

        <div id="group-languages" class="mb-5 form-group">
            <label for="languages" class="form-label fw-bold fs-5">In which language(s) does the news source publish its news texts?</label>
            <select name="languages" id="languages" class="form-select form-select-lg" placeholder="Select multiple..." aria-describedby="languages-feedback" multiple required></select>
            <small id="languages-helptext"></small>
            <div id="languages-feedback"></div>
        </div>

        <div id="group-audience-size" class="mb-5">
            <div id="group-audience-size-subscribers" class="mb-5">
                <label for="audience-size-subscribers" class="form-label fw-bold fs-5">How many people subscribe to this newspaper? <span class="text-muted">Please specify an absolute number (no percentage)</span></label>
                <input name="audience_size_subscribers" type="number" step="1" class="form-control" id="audience-size-subscribers" aria-describedby="audience-size-subscribers-feedback">
                <p><small id="audience-size-helptext">If you’re not sure about this, just skip the question.</small></p>
                <div id="audience-size-subscribers-feedback"></div>
            </div>
            <div id="group-audience-size-year" class="mb-5">
                <label for="audience-size-year" class="form-label fw-bold fs-5">For which year is this information?<span class="text-muted mx-1">(i.e., number of subscribers)</span></label>
                <input name="audience_size_year" type="number" step="1" min="1900" max="2100" class="form-control" id="audience-size-year" aria-describedby="audience-size-year-feedback" placeholder="YYYY">
                <div id="audience-size-year-feedback"></div>
            </div>
            <div id="group-audience-size-datafrom" class="mb-5">
                <label for="audience-size-datafrom" class="form-label fw-bold fs-5">Where did you get the subscriber information from? Please type the name of the data source or paste a link.<span class="text-muted mx-3">(optional)</span></label>
                <input name="audience_size_datafrom" type="text" class="form-control" id="audience-size-datafrom" aria-describedby="audience-size-datafrom-feedback" placeholder="Please specify name or a link">
                <div id="audience-size-datafrom-feedback"></div>
            </div>
            
        </div>

        <input type="button" class="btn btn-primary prev" value="Previous Step">
        <input type="button" class="btn btn-primary next" value="Next Step">
    </fieldset>

    <!-- SECTION ACCESS TO RAW TEXT AND ANNOTATION -->

    <fieldset id="section-annotations" hidden>
        <h3 class="mb-4">Access to Raw Text and Annotations</h3>
        <div id="group-epaper" class="mb-5 form-group" hidden>
            <label for="channel-epaper" class="form-label fw-bold fs-5">Does the print news source have an e-paper version? Please insert the url here:<span class="text-muted mx-3">(optional)</span></label>
            <input name="channel_epaper" type="text" class="form-control" id="channel-epaper" placeholder="Please specify (e.g., https://swmh-epaper.s4p-iapps.com/)" aria-describedby="channel-epaper-feedback">
            <div id="channel-epaper-feedback"></div>

        </div>

        <!-- Optional Field -->
        <div id="group-archive-sources-included" class="mb-5 form-group" hidden>
            <label for="archive-sources-included" class="form-label fw-bold fs-5">Are texts from the news source available for download in one or several of the following data archives?<span class="text-muted mx-3">(optional)</span></label>
            <select name="archive_sources_included" id="archive-sources-included" class="form-select form-select-lg" placeholder="Select multiple or create new ones..." aria-describedby="archive-sources-included-feedback" multiple></select>
            <small id="archive-sources-included-helptext"></small>
            <div id="archive-sources-included-feedback"></div>
        </div>

        <!-- Optional Field -->
        <div id="group-dataset-sources-included" class="mb-5 form-group">
            <label for="dataset-sources-included" class="form-label fw-bold fs-5">Is the news source included in one or several of the following annotated media text data sets?<span class="text-muted mx-3">(optional)</span></label>
            <select name="dataset_sources_included" id="dataset-sources-included" class="form-select form-select-lg" placeholder="Select multiple or create new ones..." aria-describedby="dataset-sources-included-feedback" multiple></select>
            <small id="dataset-sources-included-helptext"></small>
            <div id="dataset-sources-included-feedback"></div>
        </div>

        <input type="button" class="btn btn-primary prev" value="Previous Step">
        <input type="button" class="btn btn-primary next" value="Next Step">
    </fieldset>

    <!-- SECTION OTHER -->

    <fieldset id="section-other" hidden>
        <h3 class="mb-4">Other Information</h3>

        <!-- Optional Field -->
        <div id="group-entry-notes" class="mb-5 form-group">
            <label for="entry-notes" class="form-label fw-bold fs-5">Do you have any other notes on the source that you just coded?<span class="text-muted mx-3">(optional)</span></label>
            <input type="text" name="entry_notes" id="entry-notes" class="form-control form-control-lg" aria-describedby="entry-notes-feedback" placeholder="">
            <small id="entry-notes-helptext"></small>
            <div id="entry-notes-feedback"></div>
        </div>

        <!-- Optional Field -->
        <div id="group-related-sources" class="mb-5 form-group">
            <label for="related-sources" class="form-label fw-bold fs-5">For the source that you just coded, does it have other closely related sources? Please type their names below and start a new entry<span class="text-muted mx-3">(optional)</span></label>
            <select name="related_sources" id="related-sources" class="form-select form-select-lg" aria-describedby="related-sources-feedback" placeholder="Select multiple or add new ones..." multiple></select>
            <small id="related-sources-helptext"></small>
            <div id="related-sources-feedback"></div>

        </div>

        <div id="group-newrelated-container">

        </div>

        <input type="button" class="btn btn-primary prev" value="Previous Step">
        <input type="button" onclick="generateSummary()" class="btn btn-primary next" value="Next Step">
    </fieldset>


    <fieldset id="section-final" hidden>
        <h3>Summary</h3>

        <div id='summary-container'>
        </div>

        <input type="button" class="btn btn-primary prev" value="Previous Step">
        <input type="button" id="submit-button" class="btn btn-success" value="Submit" />
    </fieldset>
    <div class="mb-5 d-flex flex-row-reverse">
        <!-- <input type="reset" class="btn btn-danger" id="reset-form" value="Reset form" /> -->
    </div>
</form>

<script>

    // rewrite everything without jquery https://tobiasahlin.com/blog/move-from-jquery-to-vanilla-javascript/#selecting-elements
    // GLOBAL CONSTANTS
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    const csrftoken = "{{ csrf_token() }}";
    
    // ********************
    // Function declaration
    // ********************

    // Get custom attribute (data-value) from all select and put them in hidden fields
    document.querySelectorAll('select').forEach(function(item) {
        if (document.getElementById(item.id + '-hidden')) {
            item.addEventListener('change', function() {
                document.getElementById(this.id + '-hidden').value = this.options[this.selectedIndex].getAttribute('data-value')
            })
        }
    })

    function compareName( a, b ) {
        console.log(a, b)
        if ( a.name < b.name ){
            return -1;
        }
        if ( a.name > b.name ){
            return 1;
        }
        return 0;
    }

    function addFieldOptionsData(fieldOptions, key, selector) {
        var opts = fieldOptions[key] // .sort((a, b) => a.name > b.name ? 1 : -1);
        opts.forEach(function(item, i) {
            let opt = document.createElement('option')
            opt.setAttribute('value', item.unique_name)
            opt.setAttribute('data-value', item.uid)
            opt.setAttribute('data-index', i)
            opt.innerText = item.name
            document.querySelector(selector).append(opt);
        });
        let optOther = document.createElement('option')
        optOther.setAttribute('value', 'other')
        optOther.setAttribute('data-value', 'new')
        optOther.setAttribute('data-index', '99')
        optOther.innerText = 'Other'
        document.querySelector(selector).append(optOther);
    };

    function addFieldOptions(fieldOptions, key, selector, addother, othernames=false, datavalue=true) {
        var opts = fieldOptions[key] // .sort((a, b) => a.name > b.name ? 1 : -1);
        opts.forEach(function(item, i) {
            let opt = document.createElement('option')
            opt.setAttribute('value', item.uid)
            if (datavalue == true) {
                opt.setAttribute('data-value', item.unique_name)
            }
            opt.setAttribute('data-index', i)
            let item_label = item.name
            if (othernames) {
                if ('other_names' in item) {
                    item_label += ' (' + item.other_names.join(', ') + ')'
                }
            }
            opt.innerText = item_label
            document.querySelector(selector).append(opt);
        });
        if (addother) {
            let optOther = document.createElement('option')
            optOther.setAttribute('value', 'other')
            optOther.setAttribute('data-value', 'new')
            optOther.setAttribute('data-index', '99')
            optOther.innerText = 'Other'
            document.querySelector(selector).append(optOther);
        }
    };

    function addLanguages(fieldOptions, key, selector) {
        fieldOptions[key].forEach(function(item, i) {
            let opt = document.createElement('option')
            opt.setAttribute('value', item.code)
            opt.innerText = item.name
            document.querySelector(selector).append(opt);
        });
    }



    function getFieldOptions(targetUrl) {
        return new Promise(function(resolve, reject) {
            fetch(targetUrl)
                .then(data => {
                    resolve(data);
                }).catch(error => {
                    reject(error)
                })
        });
    }

    // Field Visibility Logic
    function channelVisibility(fieldOptions, allNames, el) {        
        var value = el.target.value
        var index = el.target.options[el.target.selectedIndex].getAttribute('data-index')
        if (index == null) {
            return;
        }
        allNames.forEach((elem) => elem.hidden = true);
        document.getElementById('group-channel-new').hidden = true;
        document.getElementById('group-name').hidden = false;

        if (index != 99) {
            document.querySelector("#group-name label").innerText = fieldOptions.channel[index]['form_name_question'];
            document.querySelector("#name").setAttribute("placeholder", fieldOptions.channel[index]['form_name_placeholder'])
            if ('form_name_helptext' in fieldOptions.channel[index]) {
                document.querySelector('#name-helptext').innerText = fieldOptions.channel[index]['form_name_helptext'];
            } else { document.querySelector('#name-helptext').innerText = "" };
            if ('form_name_addon' in fieldOptions.channel[index]) {
                document.querySelector("#name-addon").hidden = false;
                document.querySelector("#name-addon").innerText = fieldOptions.channel[index]['form_name_addon'];
            } else { document.querySelector("#name-addon").hidden = true; };
        } else {

            document.querySelector("#group-name label").innerText = "What is the name of the news source that you suggest?";
            document.querySelector("#name").setAttribute("placeholder", "");
            document.querySelector("#name-addon").hidden = true;
        };

        // Set / Reset certain fields to be required
        document.querySelectorAll('input[name="transcript_kind"').forEach((elem) => {
            elem.removeAttribute('required')
        })

        document.querySelector("#channel-new").removeAttribute("required");
        document.querySelectorAll('input[name="channel_comments"]').forEach((elem) => {
            elem.removeAttribute('required') 
        });

        document.querySelectorAll('input[name="payment_model"').forEach((elem) => {
            elem.removeAttribute('required')
        });
        document.querySelector("#group-archive-sources-included").hidden = true

        if (value == 'other') {
            document.querySelector("#group-channel-new").hidden = false;
            document.querySelector("#channel-new").required = true;
            document.querySelector("#group-source-founded").hidden = false;

            document.querySelector("#group-payment-model").hidden = false;
            document.querySelectorAll('input[name="payment_model"').forEach((elem) => {
                elem.setAttribute('required', true);
                elem.parentElement.hidden = false
            })
            document.querySelector("#group-archive-sources-included").hidden = false

        } else if (value == 'print') {
            document.querySelector("#group-epaper").hidden = false;
            document.querySelector("#group-audience-size").hidden = false;
            document.querySelector("#group-source-founded").hidden = false;
            document.querySelector("#group-payment-model").hidden = false;
            document.querySelectorAll('input[name="payment_model"').forEach((elem) => {
                if (elem.value == 'soft paywall') {
                    elem.setAttribute('required', false);
                    elem.parentElement.hidden = true
                }
                else {
                    elem.setAttribute('required', true);
                }
            })
            document.querySelector("#group-archive-sources-included").hidden = false


        } else if (value == 'transcript') {
            document.querySelector("#group-transcript-kind").hidden = false;
            document.querySelectorAll('input[name="transcript_kind"').forEach((elem) => {
                elem.setAttribute('required', true);
            });
            document.querySelector("#group-source-founded").hidden = false;
            document.querySelector("#group-payment-model").hidden = false;
            document.querySelectorAll('input[name="payment_model"').forEach((elem) => {
                elem.setAttribute('required', true);
                elem.parentElement.hidden = false
            })
            document.querySelector("#group-archive-sources-included").hidden = false


        } else if (value == 'website') {
            document.querySelector("#group-channel-comments").hidden = false;
            document.querySelectorAll('input[name="channel_comments"]').forEach((elem) => {
            elem.setAttribute('required', true) 
            });
            document.querySelector("#group-source-founded").hidden = false;
            document.querySelector("#group-payment-model").hidden = false;
            document.querySelectorAll('input[name="payment_model"').forEach((elem) => {
                elem.setAttribute('required', true);
                elem.parentElement.hidden = false
            })
            document.querySelector("#group-archive-sources-included").hidden = false


        }
    };

    if (document.querySelector('input[name="special_interest"]')) {
        document.querySelectorAll('input[name="special_interest"]').forEach((elem) => {
            elem.addEventListener("change", function(event) {
            var item = event.target.value;
            if (item == 'no') {
                document.getElementById('group-topical-focus').hidden = true;
                document.getElementById('topical-focus-tomselected').required = false;
                document.getElementById('topical-focus').required = false;

            }
            if (item == 'yes') {
                document.getElementById('group-topical-focus').hidden = false;
                document.getElementById('topical-focus-tomselected').required = true;
                document.getElementById('topical-focus').required = true;
            }
            });
        });
    };

    if (document.querySelector('#publication-cycle')) {
        document.getElementById('publication-cycle').addEventListener("change", function(event) {
            if (this.value == 'multiple times per week' || this.value == 'weekly' ) {
                document.getElementById('group-publication-cycle-weekday').hidden = false;

                if (this.value == 'weekly') {
                    let weekday = document.querySelectorAll('input[id^="publication-cycle-weekday-"]')
                    weekday.forEach((el) => {
                        el.setAttribute('type', 'radio')
                        el.setAttribute('name', 'publication_cycle_weekday')
                        el.setAttribute('value', el.id.replace('publication-cycle-weekday-', ''))
                        el.disabled = false
                        el.checked = false
                    });

                }
                if (this.value == 'multiple times per week') {
                    let weekday = document.querySelectorAll('input[id^="publication-cycle-weekday-"]')
                    weekday.forEach((el) => {
                        el.setAttribute('type', 'checkbox')
                        el.setAttribute('name', 'publication_cycle_weekday_' + el.id.replace('publication-cycle-weekday-', ''))
                        el.setAttribute('value', 'yes')
                        el.disabled = false
                        el.checked = false
                    });
                }
            }


            else {
                document.getElementById('group-publication-cycle-weekday').hidden = true;
            }
            });
    };

    if (document.querySelector('#publication-cycle-weekday-none')) {
        document.getElementById('publication-cycle-weekday-none').addEventListener("change", function(event) {
            if (this.checked && this.type == 'checkbox' ) {
                document.querySelectorAll('input[name^="publication_cycle_weekday"').forEach((elem) => {
                    if (!elem.id.includes('none')) {
                        elem.checked = false
                        elem.disabled = true
                    }
                });
            } 
            else {
                document.querySelectorAll('input[name^="publication_cycle_weekday"').forEach((elem) => {
                    elem.disabled = false
                });
            }
        } )
    };

    if (document.querySelector('input[name="geographic_scope"]')) {
        document.querySelectorAll('input[name="geographic_scope"]').forEach((elem) => {
            elem.addEventListener("input", function(event) {
            var item = event.target.value;
            if (item == 'multinational') {
                document.getElementById('group-geographic-scope-multiple').hidden = false;
                document.getElementById('group-geographic-scope-single').hidden = true;
                document.getElementById('group-geographic-scope-subunit').hidden = true;

                document.getElementById('geographic-scope-multiple').required = true;
                if (document.getElementById('geographic-scope-multiple-tomselected')) {
                    document.getElementById('geographic-scope-multiple-tomselected').required = true;
                }
                document.getElementById('geographic-scope-single').required = false;
                if (document.getElementById('geographic-scope-single-tomselected')) {
                    document.getElementById('geographic-scope-single-tomselected').required = false;
                }
                document.getElementById('geographic-scope-subunit').required = false;
                if (document.getElementById('geographic-scope-subunit-tomselected')) {
                    document.getElementById('geographic-scope-subunit-tomselected').required = false;
                }
                // geographicScopeSingle.clear();
                // geographicScopeSubunit.clear();
            }
            else if (item == 'national') {
                document.getElementById('group-geographic-scope-multiple').hidden = true;
                document.getElementById('group-geographic-scope-single').hidden = false;
                document.getElementById('group-geographic-scope-subunit').hidden = true;

                document.getElementById('geographic-scope-multiple').required = false;
                if (document.getElementById('geographic-scope-multiple-tomselected')) {
                    document.getElementById('geographic-scope-multiple-tomselected').required = false;
                }
                document.getElementById('geographic-scope-single').required = true;
                if (document.getElementById('geographic-scope-single-tomselected')) {
                    document.getElementById('geographic-scope-single-tomselected').required = true;
                    document.getElementById('geographic-scope-single-ts-label').innerText = "What is the national scope?"
                }

                document.getElementById('geographic-scope-subunit').required = false;
                if (document.getElementById('geographic-scope-subunit-tomselected')) {
                    document.getElementById('geographic-scope-subunit-tomselected').required = false;
                    // geographicScopeMultiple.clear();
                    // geographicScopeSubunit.clear();
                }
            }
            else if (item == 'subnational') {
                document.getElementById('group-geographic-scope-multiple').hidden = true;
                document.getElementById('group-geographic-scope-single').hidden = false;
                document.getElementById('group-geographic-scope-subunit').hidden = false;

                document.getElementById('geographic-scope-multiple').required = false;
                if (document.getElementById('geographic-scope-multiple-tomselected')) {
                    document.getElementById('geographic-scope-multiple-tomselected').required = false;
                }
                document.getElementById('geographic-scope-single').required = true;
                if (document.getElementById('geographic-scope-single-tomselected')) {
                    document.getElementById('geographic-scope-single-tomselected').required = true;
                    document.getElementById('geographic-scope-single-ts-label').innerText = "To which national context does the subnational unit belong?"
                }

                document.getElementById('geographic-scope-subunit').required = true;
                if (document.getElementById('geographic-scope-single-tomselected')) {
                    document.getElementById('geographic-scope-single-tomselected').required = true;
                }

                // geographicScopeMultiple.clear();
            }
            else {
                document.getElementById('group-geographic-scope-multiple').hidden = true;
                document.getElementById('group-geographic-scope-single').hidden = true;
                document.getElementById('group-geographic-scope-subunit').hidden = true;

                // geographicScopeSingle.clear();
                // geographicScopeMultiple.clear();
                // geographicScopeSubunit.clear();
            }
            });
        });
    };


    // populate form on page load
    function populateForm(jsonData) {
        document.getElementById("uid-hidden").value = jsonData["uid"]
        document.getElementById("channel-select").value = jsonData["channel"].unique_name
        document.getElementById("channel-select-hidden").value = jsonData["channel"].uid
        document.getElementById("name").value = jsonData["name"]
        if ("other_names" in jsonData) {
            document.getElementById("other-names").value = jsonData["other_names"].join(","); 
        };
        if ("founded" in jsonData) {
            document.getElementById("source-founded").value = jsonData["founded"].split("-")[0]
        };
        if ("payment_model" in jsonData) {
            document.querySelector(`input[name=payment_model][value='${jsonData["payment_model"]}']`).checked = true
        };
        if ("contains_ads" in jsonData) {
            document.querySelector(`input[name=contains_ads][value='${jsonData["contains_ads"]}']`).checked = true
        };
        if ("publishes_org" in jsonData) {
            jsonData["publishes_org"].forEach(function(item) {
                let opt = document.createElement('option')
                opt.setAttribute('value', item.uid)
                opt.innerText = item.name
                opt.selected = true
                document.getElementById("publishes_org").append(opt);
                if ("ownership_kind" in item) {
                    document.querySelector(`input[name=ownership_kind][value='${item["ownership_kind"]}']`).checked = true
                }
            })
        };
        if ("publishes_person" in jsonData) {
            jsonData["publishes_person"].forEach(function(item) {
                let opt = document.createElement('option')
                opt.setAttribute('value', item.uid)
                opt.innerText = item.name
                opt.selected = true
                document.getElementById("publishes_person").append(opt);
                if ("ownership_kind" in item) {
                    document.querySelector(`input[name=ownership_kind][value='${item["ownership_kind"]}']`).checked = true
                }
            })
        };
        if ("publication_kind" in jsonData) {
            jsonData["publication_kind"].forEach(function(item) {
                item = item.toLowerCase()
                if (document.querySelector(`#publication-kind option[value='${item}']`)) {
                    document.querySelector(`#publication-kind option[value='${item}']`).selected = true
                }
                else {
                    let opt = document.createElement('option')
                    opt.setAttribute('value', item)
                    opt.innerText = item
                    opt.selected = true
                    document.getElementById("publication-kind").append(opt);
                }
            })
        };
        if ("special_interest" in jsonData) {
            if (jsonData["special_interest"]) {
                document.getElementById("special_interest2").checked = true
            }
        };
        if ("topical_focus" in jsonData) {
            jsonData["topical_focus"].forEach(function(item) {
                item = item.toLowerCase()
                if (document.querySelector(`#topical-focus option[value='${item}']`)) {
                    document.querySelector(`#topical-focus option[value='${item}']`).selected = true
                }
                else {
                    let opt = document.createElement('option')
                    opt.setAttribute('value', item)
                    opt.innerText = item
                    opt.selected = true
                    document.getElementById("topical-focus").append(opt);
                }
            })
        };
        if ("publication_cycle" in jsonData) {
            document.getElementById("publication-cycle").value = jsonData["publication_cycle"]
            if ("publication_cycle_weekday" in jsonData) {
                if (jsonData["publication_cycle"] == "weekly") {
                    document.getElementById('publication-cycle').dispatchEvent(new Event("change"))
                    document.querySelector(`input[name=publication_cycle_weekday][value="${jsonData['publication_cycle_weekday'][0]}"]`).checked = true
                }
                else if (jsonData["publication_cycle"] == "multiple times per week") {
                    document.getElementById('publication-cycle').dispatchEvent(new Event("change"))
                    for (item of jsonData["publication_cycle_weekday"]) {
                        document.getElementById(`publication-cycle-weekday-${item}`).checked = true
                    }
                }
            }
        };
        if ("geographic_scope" in jsonData) {
            document.querySelector(`input[name=geographic_scope][value='${jsonData["geographic_scope"]}']`).checked = true
            document.querySelector(`input[name=geographic_scope][value='${jsonData["geographic_scope"]}']`).dispatchEvent(new Event("input"))
            if ("geographic_scope_countries" in jsonData) {
                if (jsonData["geographic_scope"] == "multinational") {
                    for (country of jsonData["geographic_scope_countries"]) {
                        if (document.querySelector(`#geographic-scope-multiple option[value='${country.unique_name}']`)) {
                            document.querySelector(`#geographic-scope-multiple option[value='${country.unique_name}']`).selected = true
                            document.getElementById("geographic-scope-countries-hidden").value += country["uid"] + ","
                            }
                        }
                    if ("geographic_scope_subunit" in jsonData) {
                        for (subunit of jsonData["geographic_scope_subunit"]) {
                            if (document.querySelector(`#geographic-scope-multiple option[value='${subunit.unique_name}']`)) {
                                document.querySelector(`#geographic-scope-multiple option[value='${subunit.unique_name}']`).selected = true
                                document.getElementById("geographic-scope-subunits-hidden").value += country["uid"] + ","
                                }
                        }
                    }
                }
                else if (jsonData["geographic_scope"] == "national") {
                    let country = jsonData["geographic_scope_countries"][0]
                    if (document.querySelector(`#geographic-scope-single option[value='${country["uid"]}']`)) {
                        document.querySelector(`#geographic-scope-single option[value='${country["uid"]}']`).selected = true
                    }
                    
                }
                else if (jsonData["geographic_scope"] == "subnational") {
                    if ("geographic_scope_subunit" in jsonData) {
                        for (subunit of jsonData["geographic_scope_subunit"]) {
                            if (document.querySelector(`#geographic-scope-subunit option[value='${subunit.uid}']`)) {
                                document.querySelector(`#geographic-scope-subunit option[value='${subunit.uid}']`).selected = true
                            }
                        }
                        let country = jsonData["geographic_scope_countries"][0]
                        if (document.querySelector(`#geographic-scope-single option[value='${country["uid"]}']`)) {
                            document.querySelector(`#geographic-scope-single option[value='${country["uid"]}']`).selected = true
                    }
                    }
                }
            }
        };
        if ("languages" in jsonData) {
            for (lang of jsonData["languages"]) {
                document.querySelector(`#languages option[value=${lang}]`).selected = true
            }

        };
        if ("channel_epaper" in jsonData) {
            document.getElementById("channel-epaper").value = jsonData["channel_epaper"]
        };
        if ("archives" in jsonData) {
            for (archive of jsonData["archives"]) {
                document.querySelector(`#archive-sources-included option[value='${archive.uid}']`).selected = true
            }
        };
        if ("datasets" in jsonData) {
            for (dataset of jsonData["datasets"]) {
                document.querySelector(`#dataset-sources-included option[value='${dataset.uid}']`).selected = true
            }
        };
        if ("entry_notes" in jsonData) {
            document.getElementById("entry-notes").value = jsonData["entry_notes"]
        };
        if ("related" in jsonData) {
            jsonData["related"].forEach(function(item) {
                let opt = document.createElement('option')
                opt.setAttribute('value', item.uid)
                opt.innerText = item.name + ' (' + item.channel.name + ')'
                opt.selected = true
                document.getElementById("related-sources").append(opt);
            })
        };
    };

    // Progress Bar
    function setProgressBar(curStep, steps) {
        var percent = parseFloat(100 / steps) * curStep;
        percent = percent.toFixed();
        document.getElementById('questionnaire-progress').style.width = percent + '%'
        document.getElementById('questionnaire-progress').setAttribute('aria-valuenow', percent + '%')
    };

    // document ready function
    var ready = (callback) => {
        if (document.readyState != "loading") callback();
        else document.addEventListener("DOMContentLoaded", callback);
    }


    ready(() => {

        // declare constants
        const formId = "new-source";
        const formUrl = location.href;
        const formIdentifier = `${formUrl} ${formId}`;
        // var persistentForm = document.querySelector(`#${formId}`)

        // Load Select options from json api
        getFieldOptions('{{ url_for("add.fieldoptions") }}')
        .then(response => response.json())
        .then(function(data) {

            addFieldOptionsData(data, 'channel', '#channel-select');
            addLanguages(data, 'language', '#languages', false);
            addFieldOptions(data, 'country', '#geographic-scope-single', false, false, false);
            addFieldOptions(data, 'subunit', '#geographic-scope-subunit', false, true, false);            
            
            addFieldOptions(data, 'archive', '#archive-sources-included', false, false, false);
            addFieldOptions(data, 'dataset', '#dataset-sources-included', false, false, false);
            
            // Add field options for Country & Subunit Selection (Multiple Choice)
            var countries = data.country;
            var subunits = data.subunit;
            // Sort values alphabetically
            // countries.sort((a,b) => a.name > b.name ? 1 : -1);
            // subunits.sort((a,b) => a.name > b.name ? 1 : -1);

            var inputGeographicScopeMultiple = document.getElementById('geographic-scope-multiple');
            var optgroupCountries = document.createElement('optgroup');
            optgroupCountries.setAttribute('label', 'Country');
            countries.forEach(function(item, i) {
                let opt = document.createElement('option')
                opt.setAttribute('value', item.unique_name)
                opt.setAttribute('data-uid', item.uid)
                opt.setAttribute('data-type', 'country')
                opt.innerText = item.name
                optgroupCountries.append(opt)
            });

            var optgroupSubunits = document.createElement('optgroup');
            optgroupSubunits.setAttribute('label', 'Subunit');
            subunits.forEach(function(item, i) {
                let opt = document.createElement('option')
                opt.setAttribute('value', item.unique_name)
                opt.setAttribute('data-uid', item.uid)
                opt.setAttribute('data-type', 'subunit')
                let item_label = item.name
                if ('other_names' in item) {
                    item_label += ' (' + item.other_names.join(', ') + ')'
                }
                opt.innerText = item_label
                optgroupSubunits.append(opt)
            });

            inputGeographicScopeMultiple.append(optgroupCountries)
            inputGeographicScopeMultiple.append(optgroupSubunits)

            inputGeographicScopeMultiple.addEventListener('change', function() {
                var hiddenGeographicScopeCountry = document.getElementById('geographic-scope-countries-hidden')
                var hiddenGeographicScopeSubunits = document.getElementById('geographic-scope-subunits-hidden')
                var selectedCountries = new Array;
                var selectedSubunits = new Array;
                for (opt of this.selectedOptions) {
                    if (opt.getAttribute('data-type') == 'country') {
                        selectedCountries.push(opt.getAttribute('data-uid'));
                    }
                    else {
                        if (opt.getAttribute('data-uid') === null) { 
                            selectedSubunits.push(opt.value);
                        }
                            selectedSubunits.push(opt.getAttribute('data-uid'));
                    }
                }
                hiddenGeographicScopeCountry.value = selectedCountries.join()
                hiddenGeographicScopeSubunits.value = selectedSubunits.join()
            });

            // get url parameter to pre-fill fields
            var currentUrl = new URL(window.location.href);
            var entry_name = currentUrl.searchParams.get("entry_name");
            document.getElementById('name').value = entry_name

            // Populate form with draft data from embedded json
            var embeddedJSON = document.getElementById('draft')
            if (embeddedJSON) {
                embeddedJSON = JSON.parse(embeddedJSON.innerHTML)
                populateForm(embeddedJSON)
            }


            // handle field visibility / dependency logic
            const channelVisibilityFields = document.querySelectorAll('#group-name, #group-epaper, #group-channel-comments, #group-transcript-kind, #group-audience-size, #group-source-founded, #group-payment-model');
            channelVisibilityFields.forEach((elem) => elem.hidden = true);
            document.getElementById('channel-select').addEventListener('change', (element) => {
                channelVisibility(data, channelVisibilityFields, element);
            })
            // trigger field events from draft
            if (embeddedJSON) {
                document.getElementById('channel-select').dispatchEvent(new Event('change'))
                if (document.getElementById("special_interest2").checked) {
                    document.getElementById("special_interest2").dispatchEvent(new Event("change"))
                    }
            }

            // add Tom Select for dynamically loaded data
            var TomSelectCountriesConfig = {
                plugins: ['remove_button'],
                create: true,
                selectOnTab: true,
                onInitialize: function() { // hacky way of forcing the field to be not-validated on load
                    this.input.classList.remove('is-invalid');
                    this.input.removeAttribute("aria-invalid");
                },
                onChange: function(){ // invoke validation on change
                    setFieldValidity(this.input);
                },
                onItemAdd:function(){ // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                }
            };
            var TomSelectCountryConfig = {
                selectOnTab: true,
                onInitialize: function() { // hacky way of forcing the field to be not-validated on load
                    this.input.classList.remove('is-invalid');
                    this.input.removeAttribute("aria-invalid");
                },
                onChange: function(){ // invoke validation on change
                    setFieldValidity(this.input);
                }
            };

            var TomSelectSubunitConfig = {
                selectOnTab: true,
                create: true,
                onInitialize: function() { // hacky way of forcing the field to be not-validated on load
                    this.input.classList.remove('is-invalid');
                    this.input.removeAttribute("aria-invalid");
                },
                onChange: function(){ // invoke validation on change
                    setFieldValidity(this.input);
                },
                onItemAdd:function(){ // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                }
            };

            const geographicScopeSingle = new TomSelect('#geographic-scope-single', TomSelectCountryConfig);
            const geographicScopeMultiple = new TomSelect('#geographic-scope-multiple', TomSelectCountriesConfig);
            const geographicScopeSubunit = new TomSelect('#geographic-scope-subunit', TomSelectSubunitConfig);


            var TomSelectLanguagesConfig = { 
                plugins: ['remove_button'],
                selectOnTab: true,
                onInitialize: function() { // hacky way of forcing the field to be not-validated on load
                    this.input.classList.remove('is-invalid');
                    this.input.removeAttribute("aria-invalid");
                },
                onChange: function(){ // invoke validation on change
                    setFieldValidity(this.input);
                },
                onItemAdd:function(){ // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                }
            };

            const languagesSelect = new TomSelect('#languages', TomSelectLanguagesConfig)

            var TomSelectDatasetConfig = { 
                selectOnTab: true,
                plugins: ['remove_button'],
                create: true,
                onItemAdd:function(){ // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                }
            }

            const archiveSelect = new TomSelect('#archive-sources-included', TomSelectDatasetConfig)
            const datasetSelect = new TomSelect('#dataset-sources-included', TomSelectDatasetConfig)

            // autocomplete organisation

            var TomSelectOrganisationConfig = {
                plugins: ['remove_button'],
                create: function(input,callback){
                        var returnData = {
                            value:input,
                            uid:input,
                            unique_name:input,
                            text:input,
                            name:input,
                            country: [
                                {name: 'NEW!'}
                            ]
                        };
                        callback(returnData);
                    },
                valueField: 'uid',
                labelField: 'name',
                searchField: 'name',
                delimiter: ',',
                selectOnTab: true,
                // createFilter: function(input) { return input.length >= 3 },
                load: function(query, callback) {
                    if ( query.length < 3 ) return callback();
                    var url = '{{ url_for("add.orglookup") }}?person=false&q=' + encodeURIComponent(query);
                    fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        callback(json.data);
                    }).catch(() => {callback();});
                },
                render: {
                    option: function(data, escape) {
                        var country_label = ' '
                        if ('country' in data) {
                            country_label = ' (' + escape(data.country[0].name) + ') '
                        };
                        return '<div>' +
                                '<span class="title">' + escape(data.name) + '</span>' +
                                '<small class="text-muted mx-1">' + country_label + '</small>' +
                            '</div>';
                    },
                    item: function(data, escape) {
                        var country_label = ' '
                        if ('country' in data) {
                            country_label = ' (' + escape(data.country[0].name) + ') '
                        };
                        return '<div>' + escape(data.name) + ' <small class="mx-1">' + country_label + '</small></div>';
                    }
                },
                onItemAdd:function(){ // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                }
            };
            new TomSelect('#publishes_org', TomSelectOrganisationConfig);

            var TomSelectPersonConfig = {
                plugins: ['remove_button'],
                create: function(input,callback){
                        var returnData = {
                            value:input,
                            uid:input,
                            unique_name:input,
                            text:input,
                            name:input,
                            country: [
                                {name: 'NEW!'}
                            ]
                        };
                        callback(returnData);
                    },
                valueField: 'uid',
                labelField: 'name',
                searchField: 'name',
                delimiter: ',',
                selectOnTab: true,
                // createFilter: function(input) { return input.length >= 3 },
                load: function(query, callback) {
                    if ( query.length < 3 ) return callback();
                    var url = '{{ url_for("add.orglookup") }}?person=true&q=' + encodeURIComponent(query);
                    fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        callback(json.data);
                    }).catch(() => {callback();});
                },
                render: {
                    option: function(data, escape) {
                        var country_label = ' '
                        if ('country' in data) {
                            country_label = ' (' + escape(data.country[0].name) + ') '
                        };
                        return '<div>' +
                                '<span class="title">' + escape(data.name) + '</span>' +
                                '<small class="text-muted mx-1">' + country_label + '</small>' +
                            '</div>';
                    },
                    item: function(data, escape) {
                        var country_label = ' '
                        if ('country' in data) {
                            country_label = ' (' + escape(data.country[0].name) + ') '
                        };
                        return '<div>' + escape(data.name) + ' <small class="mx-1">' + country_label + '</small></div>';
                    }
                },
                onItemAdd:function(){ // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                }
            };
            new TomSelect('#publishes_person', TomSelectPersonConfig);



            var TomSelectOtherNamesConfig = {
                plugins: ['remove_button'],
                selectOnTab: true,
                create: true,
                render: {
                    no_results:function(data,escape){
                        return '<div></div>';
                }
                }
            };

            new TomSelect('#other-names', TomSelectOtherNamesConfig);


            var TomSelectPublicationKindConfig = {
                plugins: ['remove_button'],
                create: true,
                selectOnTab: true,
                onInitialize: function() { // hacky way of forcing the field to be not-validated on load
                    this.input.classList.remove('is-invalid');
                    this.input.removeAttribute("aria-invalid");
                },
                onChange: function(){ // invoke validation on change
                    setFieldValidity(this.input);
            }
            };
            new TomSelect('#publication-kind', TomSelectPublicationKindConfig);

            var TomSelectTopicalFocusConfig = TomSelectPublicationKindConfig;

            new TomSelect('#topical-focus', TomSelectTopicalFocusConfig);

            // autocomplete related sources

            function createNewSourceField(container, sourceName) {
                var row = document.createElement('div')
                row.classList.add('row', 'mb-3')
                row.id = 'container-' + sourceName
                var label = document.createElement('label')
                label.classList.add('col-sm-2', 'col-form-label')
                label.setAttribute('for', 'newsource_' + sourceName)
                label.innerText = sourceName;
                row.append(label)
                var col = document.createElement('div');
                col.classList.add('col-sm-10');
                var select = document.createElement('select')
                select.classList.add('form-select')
                select.setAttribute('name', 'newsource_' + sourceName)
                
                // copy options from the first page
                select.innerHTML = document.getElementById('channel-select').innerHTML
                for (option of select) {
                    if ( option.getAttribute('data-value') == 'new') {
                        option.remove()
                    }
                    // this is a lazy way of getting two bits of data into one field
                    // we have to split this later at the comma to get the unique_name and uid
                    option.value = option.value + ',' + option.getAttribute('data-value')
                }

                // append elements
                col.append(select);
                row.append(col)

                // append to container
                document.getElementById(container).append(row) 

            }

            var TomSelectRelatedSourcesConfig = {
                plugins: ['remove_button'],
                create: function(input,callback){
                        var returnData = {
                            value:input,
                            uid:input,
                            text:input,
                            name:input,
                            geographic_scope_countries: [
                                {name: 'NEW!'}
                            ],
                            channel: 
                                {name: ''}
                        };
                        callback(returnData);
                    },
                valueField: 'uid',
                labelField: 'name',
                searchField: 'name',
                delimiter: ',',
                selectOnTab: true,
                onItemAdd: function(input) { 
                    // clear input after item was selected
                    this.setTextboxValue();
                    this.refreshOptions();
                    if (!input.startsWith('0x')) {
                        createNewSourceField('group-newrelated-container', input)
                    }
                },
                onItemRemove: function(values) {
                    if (!values.startsWith('0x')) {
                        let el = document.getElementById('container-' + values)
                        el.remove()
                    }
                },
                load: function(query, callback) {
                    if ( query.length < 3 ) return callback();
                    var url = '{{ url_for("add.sourcelookup") }}?q=' + encodeURIComponent(query);
                    fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        callback(json.data);
                    }).catch(() => {callback();});
                },
                render: {
                    option: function(data, escape) {
                        var channel_label = ' '
                        if (data.channel) {
                            if (data.channel.name) {
                            channel_label = ' (' + escape(data.channel.name) + ') '
                            }
                        };
                        var country_label = ' '
                        if ("geographic_scope_countries" in data) {
                            country_label = '<small class="text-muted mx-1"> (' + escape(data.geographic_scope_countries[0].name) + ')</small>'
                        }
                        return '<div>' +
                                '<span class="title">' + escape(data.name) + channel_label + '</span> ' +
                                country_label +
                            '</div>';
                    },
                    item: function(data, escape) {
                        var channel_label = ' '
                        if (data.channel) {
                            if (data.channel.name) {
                                var channel_label = ' (' + escape(data.channel.name) + ') '
                            }
                        };
                        var country_label = ' '
                        if ("geographic_scope_countries" in data) {
                            country_label = '<small class="text-muted mx-1"> (' + escape(data.geographic_scope_countries[0].name) + ')</small>'
                        }
                        return '<div>' + escape(data.name) + channel_label + country_label + '</div>';
                    }
                }
            };
            new TomSelect('#related-sources', TomSelectRelatedSourcesConfig);

            // Hide loading spinner and show form
            document.getElementById('loading-form').hidden = true
            document.getElementById('loading-spinner').hidden = true
            document.getElementById('loading-status').hidden = true
            document.getElementById('new-source').hidden = false

            }).catch(function(err) {
                // Run this when promise was rejected via reject()
                console.log(err)
                document.getElementById('loading-card').classList.add('text-white', 'bg-danger')
                document.getElementById('loading-spinner').setAttribute('style', 'animation: unset;')
                document.getElementById('loading-spinner').classList.remove('text-primary')
                document.getElementById('loading-status').innerText = "Sorry, something went wrong..."
                document.getElementById('loading-status-message').innerText = "Please try to reload this page. If the issue persists, please contact the admins."
            })       

        // form progression in multiple steps
        var current = 0;
        var currentStep;
        var nextStep;
        var prevStep
        steps = document.querySelectorAll("fieldset").length;
        document.querySelectorAll('.next').forEach((nextbutton) => {
            nextbutton.addEventListener('click', function() {
                currentStep = nextbutton.parentElement;

                for (field of currentStep.elements) {
                    if (!visited.includes(field)) {
                        visited.push(field);
                        // hacky solution to prevent validation loop
                        if (field.id == "languages-tomselected") {
                            field.checkValidity();
                        }
                        else {
                        field.reportValidity();
                        }
                    }
                };
                for (field of currentStep.elements) {
                    if (!field.validity.valid) {
                        // field.reportValidity();
                        return;
                    };
                };
                nextStep = nextbutton.parentElement.nextElementSibling;
                currentStep.hidden = true;
                nextStep.hidden = false
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera

                setProgressBar(++current, steps);

            });

        });

        document.querySelectorAll('.prev').forEach((prevbutton) => {
            prevbutton.addEventListener('click', function() {
                currentStep = prevbutton.parentElement;
                prevStep = prevbutton.parentElement.previousElementSibling;
                currentStep.hidden = true;
                prevStep.hidden = false;
                setProgressBar(--current, steps);
            });
        });
        setProgressBar(current, steps);

    }); 

    // validation & submission

    const form = document.getElementById("new-source");
    form.noValidate = true;

    const submitButton = document.getElementById('submit-button')

    async function successRedirect(redirect) {
        await new Promise(r => setTimeout(r, 500));
        location.assign(redirect)


    }

    // button to go back after failed submission

    var submitFailButton = document.getElementById('btn-fail-goback') 
    submitFailButton.addEventListener('click', function() {
        document.getElementById('loading-form').hidden = true
        document.getElementById('loading-card').classList.remove('text-white')
        document.getElementById('loading-card').classList.remove('bg-danger')
        document.getElementById('loading-spinner').hidden = true
        document.getElementById('loading-spinner').removeAttribute('style')
        document.getElementById('loading-spinner').classList.add('text-primary')
        document.getElementById('btn-fail-goback').hidden = true

        document.getElementById('loading-status').innerText = "Processing data..."
        document.getElementById('loading-status-message').innerText = "Please be patient for a short while"
        document.getElementById('loading-status').hidden = true
        document.getElementById('new-source').hidden = false

    })

    function formResult(success, data) {
        if (success) {

                if ("error" in data) {
                    document.getElementById('loading-card').classList.add('text-white', 'bg-danger')
                    document.getElementById('loading-spinner').setAttribute('style', 'animation: unset;')
                    document.getElementById('loading-spinner').classList.remove('text-primary')
                    document.getElementById('loading-status').innerText = "We got a problem"
                    document.getElementById('loading-status-message').innerText = data.error
                    document.getElementById('btn-fail-goback').hidden = false


                }
                else {
                    document.getElementById('loading-spinner').classList.add('text-success')
                    document.getElementById('loading-spinner').classList.remove('text-primary')
                    document.getElementById('loading-spinner').hidden = true
                    document.getElementById('submit-success-icon').hidden = false
                    document.getElementById('loading-status').innerText = "Success!"
                    document.getElementById('loading-status-message').innerText = "Everything looks good"
                    document.getElementById('btn-viewentry').hidden = false
                    document.getElementById('btn-viewentry').setAttribute('href', data.redirect)
                    document.getElementById('btn-add-another').hidden = false
                }

                
            }
            else {
                document.getElementById('loading-card').classList.add('text-white', 'bg-danger')
                document.getElementById('loading-spinner').setAttribute('style', 'animation: unset;')
                document.getElementById('loading-spinner').classList.remove('text-primary')
                document.getElementById('loading-status').innerText = "Failed"
                document.getElementById('loading-status-message').innerText = "Server not responding!"
                document.getElementById('btn-fail-goback').hidden = false
            }

    }

    submitButton.addEventListener('click', function handleFormSubmit(event) {
        var isValid = form.reportValidity();

        if (isValid) {
            event.preventDefault();
            // POST form data to backend with fetch
            document.getElementById('new-source').hidden = true
            document.getElementById('loading-form').hidden = false
            document.getElementById('loading-spinner').hidden = false
            document.getElementById('loading-status').innerText = "Processing data..."
            document.getElementById('loading-status-message').innerText = "Please be patient for a short while"
            document.getElementById('loading-status').hidden = false
            submitForm('{{ url_for("add.submit") }}', form, formResult);


            // window.location.assign('{{ url_for("add.confirmation") }}')
        };

        event.preventDefault();
        });

    const visited = [];
    for (const field of form.elements) {
        field.addEventListener("invalid", function handleInvalidField(event) {
            setFieldValidity(field);
            event.preventDefault();
        });
        
        field.addEventListener("valid", function handleInvalidField(event) {
            setFieldValidity(field);
            event.preventDefault();
        });

        field.addEventListener("blur", function handleFieldBlur() {
            
            if (!visited.includes(field)) {
                visited.push(field);
                }
            field.checkValidity();
        });

        field.addEventListener("input", function handleFieldInput(event) {
            if (!visited.includes(field)) return;
            setFieldValidity(field); 
            
        });

        }

    function errorContainer(field) {
        const errorContainerId = field
            .getAttribute("aria-describedby")
            .split(" ")
            .find((id) => id.includes("feedback"));
        return document.getElementById(errorContainerId);
    }

    function setFieldValidity(field) {
        if (!field.validity.valid) {
            errorContainer(field).textContent = field.validationMessage;
            errorContainer(field).classList.add('invalid-feedback');
            field.setAttribute("aria-invalid", "true");
            field.classList.add('is-invalid');
        } else {
            errorContainer(field).textContent = "";
            errorContainer(field).classList.remove('invalid-feedback');
            field.removeAttribute("aria-invalid");
            field.classList.remove('is-invalid');
            if (field.type == 'radio') {
                document.querySelectorAll(`input[name=${field.name}]`).forEach(function (el) {
                    errorContainer(el).classList.remove('invalid-feedback');
                    el.removeAttribute("aria-invalid");
                    el.classList.remove('is-invalid');
                });
            };
        }
    }


    // submit form

    function serializeForm(f) {
        var obj = {};
        var formData = new FormData(f);
        
        var obj = Object.fromEntries(
            Array.from(formData.keys()).map(key => [
                key, formData.getAll(key).length > 1 ? 
                formData.getAll(key) : formData.get(key)
            ])
            )
        
        // remove empty strings
        var obj = Object.fromEntries(Object.entries(obj).filter(([_, v]) => v != ""));

        return obj;
        };

    function submitForm(endpoint, form, callback) {
        var xhr = new XMLHttpRequest();
        var url = endpoint;
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                var json = JSON.parse(xhr.responseText);
                console.log(json);
                let success = true
                 callback(success, json)
            }
            else {
                console.log("error", xhr.statusText, xhr.responseText)
                let success = false
                var error = xhr.statusText
                callback(success, error)
            }
        }
        };
        var data = JSON.stringify(serializeForm(form));
        xhr.send(data);

    };

    

    // summary at the end

    function generateSummary() {

        data = serializeForm(document.getElementById('new-source'));

        var descriptionList = document.createElement('dl')
        descriptionList.classList.add('row')

        for (const [key, value] of Object.entries(data)) {
            var question = document.createElement('dt');
            question.classList.add('col-sm-4');
            question.innerText = key;
            var answer = document.createElement('dd');
            answer.classList.add('col-sm-8');
            answer.innerText = value;

            descriptionList.append(question)
            descriptionList.append(answer)

        }

        document.getElementById('summary-container').append(descriptionList);


        // var formFields = document.querySelectorAll('#new-source input, select');
        // for ( var i = 0; i < formFields.length; i++) {

        //     if ( formFields[i].hidden || formFields[i].type == 'button' || formFields[i].id.endsWith('-tomselected') ) {
        //         continue
        //     }

        //     if (formFields[i].type == 'radio' ) {
        //         if (!formFields[i].checked) {
        //             continue
        //         }
        //     }

        //     console.log(formFields[i].id)

        //     var question = document.createElement('dt');
        //     question.classList.add('col-sm-4');
        //     var answer = document.createElement('dd');
        //     answer.classList.add('col-sm-8');

        //     if (formFields[i].type == 'radio') {
        //         question.innerText = document.querySelector('[for="' + formFields[i].name + '"]').innerText
        //     }
        //     else {
        //     question.innerText = document.querySelector('label[for="' + formFields[i].id + '"]').innerText
        //     }
        //     answer.innerText = formFields[i].value

        //     descriptionList.append(question)
        //     descriptionList.append(answer)


        // }



    }


</script>
{% if draft %}
<script type="application/json" id="draft">
{{ draft|safe }}
</script>
{% endif %}
{% endblock content %} {% block sidebar %} {% endblock sidebar %}