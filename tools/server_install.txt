# install basics

apt update
apt upgrade
apt install curl git ufw nano htop python3-venv python3-pip libxml2-dev libxslt-dev python-dev -y
python3 -m pip install wheel waitress requests

# change ssh port
nano /etc/ssh/sshd_config
service ssh restart

# configure firewall

ufw allow 5000 # dev server port
ufw allow 8472 # ssh port
ufw enable

# install dgraph with systemd service

curl https://get.dgraph.io -sSf | bash -s -- --systemd

# in some cases need to fix systemd config:
https://discuss.dgraph.io/t/automatic-download-installation-with-systemd-throws-error/15080/2

# to set systemd manually, do the following

## Install Dgraph 

curl https://get.dgraph.io -sSf | bash

## Create Dgraph user
groupadd --system dgraph
useradd --system -d /var/lib/dgraph -s /bin/false -g dgraph dgraph

## Create Directories & set permissions
mkdir -p /var/lib/dgraph/{p,w,zw}
mkdir -p /var/log/dgraph

mkdir /mnt/public/backup

chown -R dgraph:dgraph /var/{lib,log}/dgraph
chown -R dgraph:dgraph /mnt/public/backup

## Create systemd service files
nano /etc/systemd/system/dgraph-zero.service
nano /etc/systemd/system/dgraph-alpha.service

## Reload Daemon

systemctl daemon-reload

## Enable services
systemctl enable dgraph-zero
systemctl status dgraph-zero





# if this fails, try using docker
docker run -it -p 5080:5080 -p 6080:6080 -p 8080:8080 -p 9080:9080 -p 8000:8000 -v ~/dgraph:/dgraph --name dgraph dgraph/standalone:v21.03.0


# add new user

adduser ava

# login as new user

# create venv
python3 -m venv environments/wp3

# get source from github
git clone ....

# install python dependencies
source environments/wp3/bin/activate

python -m pip install wheel waitress
python -m pip install -r requirements.txt

# set app secret key
export flaskinventory_SECRETKEY=123456789

# setup dgraph schema
python tools/setschema.py

# upload sample data
python tools/sample_data.py

# Run flask with waitress to test installation
waitress-serve --call --listen "*:5000" 'flaskinventory:create_app'

# run flask as systemd service
# requires root access
sudo nano /etc/systemd/system/flaskinventory.service
sudo systemctl enable flaskinventory
sudo service flaskinventory start